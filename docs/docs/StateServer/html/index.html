<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StateServer: State Server</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">StateServer<span id="projectnumber">&#160;1.5.4</span>
   </div>
   <div id="projectbrief">Compiled `c` application to handle task state logging and timing.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">State Server </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a> Compiled <code>c</code> application to handle task state logging and timing. <br  />
</p>
<p><em><a href="https://code.nml.wtf/docs">(Return)</a></em></p>
<hr  />
<h1><a class="anchor" id="contents"></a>
Contents</h1>
<ul>
<li><a class="el" href="#state-machine">State Machine</a></li>
<li><a class="el" href="#compiling">Compiling</a><ul>
<li><a class="el" href="#main-applications">Main Applications</a><ul>
<li><a class="el" href="#nhp-wrist-state-server">`NHP_Wrist_State_Server.exe`</a></li>
</ul>
</li>
<li><a class="el" href="#test-applications">Test Applications</a><ul>
<li><a class="el" href="#nhp-wrist-controller-test">`NHP_Wrist_Controller_Test.exe`</a></li>
<li><a class="el" href="#nhp-wrist-parameters-test">`NHP_Wrist_Parameters_Test.exe`</a></li>
<li>`NHP_Wrist_Requests_Test.exe`</li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="#note-about-gcc">Using `gcc` on Windows</a></li>
</ul>
<h1><a class="anchor" id="state-machine"></a>
State Machine</h1>
<p>The wrist center-out task state machine for the NHP task runs as shown by the following image generated using <a href="https://graphviz.org/download/"><code>graphviz</code></a>: <br  />
 <img src="state_transition_flowchart.png" alt="Figure 1: NHP wrist center-out task state machine." class="inline"/>. <br  />
 To modify this image, you need to update the corresponding lines in <code>state_transition_flowchart.dot</code> (which is located in the project root of this repository). After modifying <code>state_transition_flowchart.dot</code>, you must regenerate the static image file that is used in the documentation. To do so, first make sure that <a href="https://graphviz.org/download/"><code>graphviz</code></a> is installed on your device and that the associated binaries folder (e.g. <code>C:/Program Files/graphviz/bin</code>) is in your environment <code>PATH</code> variable. With <code>graphviz</code> installed and on the <code>PATH</code>, issue the following command from a Windows Terminal: <br  />
 </p><div class="fragment"><div class="line">dot -Tpng state_transition_flowchart.dot -o &quot;%NML_DOXY_DOCS_DIRECTORY%/StateServer/html/state_transition_flowchart.png&quot;</div>
</div><!-- fragment --><h1><a class="anchor" id="compiling"></a>
Compiling</h1>
<h2><a class="anchor" id="main-applications"></a>
Main Applications</h2>
<h3><a class="anchor" id="nhp-wrist-state-server"></a>
<b>NHP Wrist State Server</b></h3>
<p><em>This application launches the State Server on a Windows host. It should be run on some other machine than the Plexon rig computer, but preferably still a good computer. <b>Important:</b> <code>config.yaml</code> <b>must be present</b> in whichever folder contains the <code>NHP_Wrist_State_Server.exe</code> when it is run. Therefore, if you copy the executable out of that folder make sure you copy <code>config.yaml</code> along with it. <b>You must properly set up <code>config.yaml</code> according to the current configuration of devices in your task network, or this executable will not work!</b></em> <br  />
</p>
<p>To re-compile the executable <code>bin/NHP_Wrist_State_Server.exe</code> use the following command: </p><div class="fragment"><div class="line">cd %NML_NHP_C_PROJECTS%/StateServer &amp;&amp; gcc src/state_server.c -o bin/NHP_Wrist_State_Server.exe -Iinclude -Llib -lNetwork -lws2_32 -lLogUtilities -lTaskParameters -lDataStructures -lTiming -lMathUtilities &amp;&amp; doxygen</div>
</div><!-- fragment --><p> <b>Note 1:</b> it is critically important to link <code>ws2_32</code> only after <code>Network</code>; also, since the other libraries include <code>&lt;Windows.h&gt;</code>, <code>-lws2_32</code> must precede any of the other libraries. <br  />
 <b>Note 2:</b> during the compilation and linking of the static <code>lib/Network.lib</code> (in <a href="https://code.nml.wtf/docs/NetworkUtilities/html/index.html"><code>NetworkUtilities</code></a>), please make sure to <em><b>not</b></em> link <code>-lws2_32</code> in the gcc static object file generation step. The static library does not require external libraries; the external libraries should only be linked in the final compilation step (i.e. when producing a <code>.dll</code> dynamic link library or when producing a <code>.exe</code> executable to run the application). <br  />
</p>
<p><b>More Details on State Server</b> <br  />
 <code>NHP_Wrist_State_Server.exe</code> has 5 main threads: a "Clock" thread, a "Controller" thread, an "Input" thread, a "State" thread, and an "Output" thread. The threads are managed using <code>pthread_mutex_t</code> and <code>pthread_cond_t</code> to ensure proper synchronization, cycling in the sequence <code>Clock &gt; Controller &gt; Input &gt; State &gt; Output &gt; Clock &gt; ...</code> in a manner that is guaranteed to complete one full cycle before any other thread completes another round of handling its duties. <br  />
</p><ul>
<li>The timestamp of each update cycle is generated at the beginning of every round in the handler thread rotation, from the <code>Clock</code> thread. Essentially the only job of this thread is to wait for the specified amount of time (currently set to 0.001s) upon waking with control of the <code>mutex</code> (which is when it starts the desired timer). On a Windows 64-bit machine, the timer resolution for this wait cycle should typically be dictated by a clock with 100MHz precision (i.e. it can be as fast to update as 10-us although that is really not recommended).</li>
<li>The <code>Controller</code> handler thread receives inputs from a "Controller" network device, which <em>could</em> be the same as the device running this state machine but might have to be a separate computer. The "Controller" computer can likely be a "light-weight" machine as it really just serves as a user interface/front-end. The <code>Control</code> commands do things like put the task into an Idle state, Enable/Disable Logging, or Shutdown the entire interface. This is also the phase where parameter updates are taken (again from the "Controller" computer). Any parameter updates that need to be relayed to the "Renderer" device are also forwarded at this stage. Finally, any experimentally-relevant metadata that breaks up files, like changing Subject or starting a new "Set" (i.e. swapping Orientation or other behavioral variable) is handled in this stage and sets flags in the event that logging is enabled.</li>
<li>The <code>Input</code> handler thread receives new cursor positions (e.g. from <code>PotentiometerClient.exe</code> running on the Plexon rig or other networked machine connected to the Omniplex network streams). This allows flexibility in the way the inputs are treated. No transformation on the <code>Input</code> position happens; it is purely a relay to the <code>TaskRender</code> machine that ensures concurrency for logging the state of the task, including the cursor. <br  />
</li>
<li>The <code>State</code> handler thread is where state checks occur. These checks include calculations like determining if the cursor is within a specific target, or if sufficient time has proceeded to allow a hold state to advance to the next task state.</li>
<li>The <code>Output</code> handler thread mediates sending the cursor position to the "Renderer" device. It also sends the target locations to the "Renderer" device. Target positions are updated during the <code>ADVANCE</code> transition into <code>T1_MOVE</code>; additional target messages are generated during <code>T2_SHOW</code> and <code>T1_GO</code> states to show T2 and hide T1, respectively. <br  />
<ul>
<li>At the end of the <code>Output</code> handling, the current state is logged along with its timestamp. This includes the cursor position, task state, transition state, and some other details.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="test-applications"></a>
Test Applications</h2>
<p>To re-compile all test executables, use the following bash command: <br  />
 </p><div class="fragment"><div class="line">cd %NML_NHP_C_PROJECTS%/StateServer &amp;&amp; gcc tests/test_controller.c -o bin/tests/NHP_Wrist_Controller_Test.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lLogUtilities -lDataStructures &amp;&amp; gcc tests/test_parameters.c -o bin/tests/NHP_Wrist_Parameters_Test.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lTaskParameters -lLogUtilities -lDataStructures &amp;&amp; gcc tests/test_log_reader.c -o bin/tests/NHP_Wrist_Log_Reader_Test.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lLogUtilities -lTaskParameters -lDataStructures</div>
</div><!-- fragment --><h3><a class="anchor" id="nhp-wrist-controller-test"></a>
<b>NHP Wrist Controller Test</b></h3>
<p><em>This should be run after starting <code>NHP_Wrist_State_Server.exe</code>. It sends a few test commands to the server, checking that the <code>controllerHandlerThread</code> correctly receives the control commands to enter the idle state, exit the idle state, and shut down.</em> <br  />
</p>
<p>To re-compile the executable <code>bin/tests/NHP_Wrist_Controller_Test.exe</code> use the following command: </p><div class="fragment"><div class="line">gcc tests/test_controller.c -o bin/tests/NHP_Wrist_Controller_Test.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lLogUtilities -lDataStructures</div>
</div><!-- fragment --><h3><a class="anchor" id="nhp-wrist-parameters-test"></a>
<b>NHP Wrist Parameters Test</b></h3>
<p><em>This should be run after starting <code>NHP_Wrist_State_Server.exe</code>. It sends an example parameter message to the server, checking that the <code>controllerHandlerThread</code> correctly updates the received parameters message.</em> <br  />
</p>
<p>To re-compile the executable <code>bin/tests/NHP_Wrist_Parameters_Test.exe</code> use the following command: </p><div class="fragment"><div class="line">gcc tests/test_parameters.c -o bin/tests/NHP_Wrist_Parameters_Test.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lTaskParameters -lLogUtilities -lDataStructures </div>
</div><!-- fragment --><h3><a class="anchor" id="nhp-wrist-log-reader-test"></a>
<b>NHP Wrist Log Reader Test</b></h3>
<p><em>This should be run after starting <code>NHP_Wrist_State_Server.exe</code>. It sends an example parameter message to the server, checking that the <code>outputHandlerThread</code> correctly issues a sound request message (i.e. as would occur on different task cues in the corresponding state) and finally that it correctly issues a reward request message (which prompts sending back a message with updated target locations).</em> <br  />
</p>
<p>To re-compile the executable <code>bin/tests/NHP_Wrist_Log_Reader_Test.exe</code> use the following command: </p><div class="fragment"><div class="line">gcc tests/test_log_reader.c -o bin/tests/NHP_Wrist_Log_Reader_Test.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lLogUtilities -lTaskParameters -lDataStructures </div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="deprecated-tests"></a>
Deprecated Tests</h2>
<p><em>Tests under this header are likely deprecated but might still be useful so they are hanging around.</em> <br  />
</p>
<h3><a class="anchor" id="test-ui"></a>
<b>Test UI</b></h3>
<p><em>Tests the (kind of old honestly) Windows <code>c</code> API for user interfaces.</em> <br  />
 To re-compile the executable <code>bin/tests/ui.exe</code> use the following command: <br  />
 </p><div class="fragment"><div class="line">gcc deprecated/ui.c -o bin/tests/ui.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lDataStructures -lTaskParameters -lTiming</div>
</div><!-- fragment --><h3><a class="anchor" id="test-ui-sender"></a>
<b>Test UI Sender</b></h3>
<p><em>Sends messages to the test UI interface. Note that the message exchange format is likely broken at this point due to other library changes that happened after this became deprecated.</em> <br  />
</p>
<p>To re-compile the executable <code>bin/tests/test_sender.exe</code> use the following command: </p><div class="fragment"><div class="line">gcc deprecated/test_sender.c -o bin/tests/test_sender.exe -Iinclude -Isrc -Llib -lNetwork -lws2_32 -lDataStructures -lTiming -lTaskParameters</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="note-about-gcc"></a>
Note about gcc</h1>
<p>Note that to use <code>gcc</code> on a Windows 64-bit architecture, the simplest way is to download `msys2`, which will allow you to use <code>pacman</code> from an <code>msys2</code> terminal. You can first check to see if you already have <code>gcc</code> installed: </p><div class="fragment"><div class="line">pacman -Q | grep mingw-w64-x86_64-gcc</div>
</div><!-- fragment --><p> If you see anything in the terminal following this command, it means you already have <code>gcc</code>. Otherwise, you need to install it (and probably the rest of the toolchain, such as a linker etc.): <br  />
 </p><div class="fragment"><div class="line">pacman -S mingw-w64-x86_64-toolchain</div>
</div><!-- fragment --><p> This will give several options for what you can install. If you are unsure what to do, just install all of them. <br  />
 Finally, you may also want a toolchain for compiling 32-bit applications from your 64-bit Windows operating system. In that case, you can try: <br  />
 </p><div class="fragment"><div class="line"> (bash)</div>
<div class="line">pacman -S mingw-w64-i686-toolchain</div>
</div><!-- fragment --><p> The last step is to make sure the folder with the correct binaries are on your <code>PATH</code> environment variable. Probably the best strategy here, on a Windows device, is as follows: <br  />
</p><ol type="1">
<li>Open the Start menu and type Environment, this should bring up a Control Panel shortcut to "Edit the System Environment Variables." Click that. <br  />
</li>
<li>Click "Environment Variables..." at the bottom right. <br  />
</li>
<li>Under System Variables, click "New..." and define a new environment variable: <code>MINGW_PATH</code>. If you installed <code>msys2</code> in the default location, then go to <code>C:/mingw64</code>. You will be looking for the sub-folder containing binaries. In my install, that is located at <code>C:\msys64\mingw64\bin</code> &ndash; so that is my <code>MINGW_PATH</code> environment variable. <br  />
</li>
<li>Under User Variables, find <code>Path</code>. Click <code>Edit...</code> with <code>Path</code> selected. <br  />
</li>
<li>In the new popup, click <code>New</code> to add a new <code>Path</code> value. Enter <code>MINGW_PATH%</code>. Now, you can add or remove <code>MINGW_PATH%</code> from the user <code>Path</code> variable depending on what compiler needs you have. Click on the newly added value, and click <code>Move Up</code> until it is at the top of the list. This ensures we don't accidentally find <code>gcc</code> somewhere else and use a different unintended version. Note that if you want to switch between i.e. <code>C:\msys64\mingw32\bin</code> and <code>C:\msys64\mingw64\bin</code> it might just be easiest to change the value of <code>MINGW_PATH</code> environment variable. <br  />
 </li>
</ol>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
